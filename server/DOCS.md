# Anonymous Blocking Server
## REST API
### Authorisation
The REST API is authorised using a [JSON Web Token](https://jwt.io/), which is signed by the mobile client using a secret key known only to the mobile client and server.

The token contains an anonymous unique identifier for the user generated by the mobile client. The server verifies each token that it receives has been signed with the known secret key, and rejects any requests that fail this verification step.  
#### Request
To make an authorised request to the server, include the following header:

| HEADER | TYPE | REQUIRED | EXAMPLE |
|---|---|---|---|
| Authorization | string | true | `'Bearer <JWT_TOKEN>'` |

The JWT Token should contain the following payload:
```JSON
{
  "id": "ANONYMOUS_UNIQUE_ID"
}
```

### Sessions
#### Start Session
Start a session for the authorised user. If an `endDate` parameter is sent the session will run until that time, else the session will run until stopped.

Starting a new session whilst an existing session is running will stop the running session before starting the new session.
```
POST /session
```
| PARAMETER | TYPE | REQUIRED | EXAMPLE |
|---|---|---|---|
| endDate | ISO string | false | `'2021-02-27T09:00:00.000+00:00'` |
| services | Array of service objects | true | `[{ "name":  "facebook" }, { "name":  "reddit" }]` |

#### Stop Session
Stop the session for the authorised user.

Stopping a session while a schedule is running will also stop the running schedule.
```
DELETE /session
```

### Schedules
#### Get All Schedules
Get all the schedules for the authorized user.
```
GET /schedules
```
##### Example Response
```JSON
{
  "data": {
    "schedules": [
      {
        "id": "123",
        "name": "Morning Focus",
        "type": "one-off",
        "services": [{ "name":  "facebook" }, { "name":  "reddit" }],
        "startDate": "2021-02-27T09:00:00.000+00:00",
        "duration": 120
      },
      {
        "id": "456",
        "name": "Afternoon Focus",
        "type": "repeated",
        "services": [{ "name":  "facebook" }, { "name":  "reddit" }],
        "duration": 120,
        "repeats": [
          "* * 14 * * 1",
          "* * 14 * * 3",
          "* * 14 * * 5"
        ]
      }
    ]
  }
}
```
#### Create a schedule
Create a schedule for the authorized user.

A schedule can be of type `one-off` or `repeated`.

A `one-off` schedule is executed once at `startDate` for `duration` minutes.

A `repeated` schedule is executed for each cron time specified in `repeats` for `duration` minutes.
```
POST /schedule/<SCHEDULE_ID>
```
| PARAMETER | TYPE | REQUIRED | EXAMPLE |
|---|---|---|---|
| name | string | true | `'Morning Focus'` |
| type | string | true | Either `'one-off'` OR `'repeated'` |
| services | Array of service objects | true | `[{ "name":  "facebook" }, { "name":  "reddit" }]` |
| duration | number (minutes) | true | `120` |
| startDate | ISO String | true if type is `'one-off'` | `'2021-02-27T09:00:00.000+00:00'` |
| repeats | Array of cron strings | true if type is `'repeated'` | `[ "* * 14 * * 1", "* * 14 * * 3" ]` |
#### Delete a schedule
Delete a schedule for the authorized user.
```
DELETE /schedule/<SCHEDULE_ID>
```
### Blocked services
#### Get blocked services
Get information on services that are currently blocked for the authorised user, and whether they are blocked by a `schedule` or `session`
```
GET /blocked
```
##### Example Response
```JSON
{
  "data": {
    "services": [{ "name":  "facebook" }, { "name":  "reddit" }],
    "blocker": {
      "type": "schedule",
      "id": 123
    }
  }
}
```
## Socket API
### Emitted Messages
#### Blocking started
Message emitted when blocking is started via either a session or a schedule.
##### Example Message
```
MESSAGE 'blocking-started'
DATA { 
    blocker: {
        type: 'session', 
        id: 123
    }
    services: [{ name:  "facebook" }, { name:  "reddit" }]
}
```
#### Blocking ended
Message emitted when blocking is ended manually or via a schedule.
##### Example Message
```
MESSAGE 'blocking-ended'
```
